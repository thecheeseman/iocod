#include <math.h>

#include "ic_test.h"

/* easy wrapper */
#define FEQUAL(a, b) (fabs(a - b) < 0.00001)

static char test_data[] = {
    0x34, 0x32, 0x0a, 0x33, 0x2e, 0x31, 0x34, 0x0a, 0x75, 0x6e, 0x71, 0x75, 
    0x6f, 0x74, 0x65, 0x64, 0x5f, 0x74, 0x65, 0x78, 0x74, 0x0a, 0x22, 0x74, 
    0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x61, 0x20, 0x74, 0x65, 0x73,
    0x74, 0x20, 0x73, 0x74, 0x72, 0x69, 0x6e, 0x67, 0x22, 0x0a, 0x28, 0x20, 
    0x33, 0x32, 0x30, 0x2e, 0x34, 0x34, 0x20, 0x2d, 0x31, 0x35, 0x34, 0x34, 
    0x2e, 0x39, 0x35, 0x20, 0x31, 0x32, 0x38, 0x39, 0x37, 0x2e, 0x35, 0x35, 
    0x20, 0x29, 0x0a, 0x0a, 0x7b, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x2f, 
    0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x73, 0x65, 0x63, 0x74, 0x69, 0x6f, 
    0x6e, 0x20, 0x73, 0x68, 0x6f, 0x75, 0x6c, 0x64, 0x20, 0x62, 0x65, 0x20, 
    0x73, 0x6b, 0x69, 0x70, 0x70, 0x65, 0x64, 0x20, 0x65, 0x6e, 0x74, 0x69, 
    0x72, 0x65, 0x6c, 0x79, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x2f, 0x2f, 0x20, 
    0x73, 0x6f, 0x20, 0x69, 0x74, 0x20, 0x64, 0x6f, 0x65, 0x73, 0x6e, 0x27, 
    0x74, 0x20, 0x6d, 0x61, 0x74, 0x74, 0x65, 0x72, 0x20, 0x77, 0x68, 0x61, 
    0x74, 0x27, 0x73, 0x20, 0x61, 0x63, 0x74, 0x75, 0x61, 0x6c, 0x6c, 0x79, 
    0x20, 0x68, 0x65, 0x72, 0x65, 0x0a, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x72,
    0x61, 0x6e, 0x64, 0x6f, 0x6d, 0x20, 0x3d, 0x20, 0x35, 0x0a, 0x20, 0x20, 
    0x20, 0x20, 0x64, 0x6f, 0x5f, 0x74, 0x68, 0x69, 0x73, 0x3b, 0x0a, 0x7d, 
    0x0a, 0x0a, 0x2f, 0x2a, 0x0a, 0x20, 0x20, 0x20, 0x20, 0x68, 0x65, 0x72,
    0x65, 0x27, 0x73, 0x20, 0x61, 0x20, 0x6d, 0x75, 0x6c, 0x74, 0x69, 0x2d, 
    0x6c, 0x69, 0x6e, 0x65, 0x20, 0x63, 0x6f, 0x6d, 0x6d, 0x65, 0x6e, 0x74, 
    0x20, 0x74, 0x68, 0x61, 0x74, 0x20, 0x73, 0x68, 0x6f, 0x75, 0x6c, 0x64, 
    0x20, 0x62, 0x65, 0x20, 0x69, 0x67, 0x6e, 0x6f, 0x72, 0x65, 0x64, 0x0a, 
    0x20, 0x20, 0x20, 0x20, 0x63, 0x61, 0x6e, 0x27, 0x74, 0x20, 0x70, 0x75, 
    0x74, 0x20, 0x74, 0x68, 0x69, 0x73, 0x20, 0x61, 0x73, 0x20, 0x70, 0x61, 
    0x72, 0x74, 0x20, 0x6f, 0x66, 0x20, 0x61, 0x20, 0x73, 0x74, 0x72, 0x69, 
    0x6e, 0x67, 0x20, 0x73, 0x6f, 0x20, 0x69, 0x20, 0x64, 0x69, 0x64, 0x20, 
    0x2f, 0x23, 0x20, 0x23, 0x2f, 0x20, 0x69, 0x6e, 0x73, 0x74, 0x65, 0x61, 
    0x64, 0x0a, 0x2a, 0x2f, 0x0a, 0x0a, 0x74, 0x72, 0x75, 0x65, 0x00
};

/*
42
3.14
unquoted_text
"this is a test string"
( 320.44 -1544.95 12897.55 )

{
    // this section should be skipped entirely
    // so it doesn't matter what's actually here

    random = 5
    do_this;
}

/#
    here's a multi-line comment that should be ignored
    can't put this as part of a string so i did /# #/ instead
#/

true
*/

int TEST_MAIN()
{
    char *data = test_data;

    ps_begin_session("test_data");
    
    /* integer */
    IC_ASSERT(ps_parse_integer(&data) == 42);

    /* float/double */
    IC_ASSERT(FEQUAL(ps_parse_value(&data), 3.14));

    /* identifier */
    char *token = ps_parse(&data);
    IC_ASSERT(strcmp(token, "unquoted_text") == 0);

    /* quoted string */
    token = ps_parse(&data);
    IC_ASSERT(strcmp(token, "this is a test string") == 0);

    /* 1d matrix */
    vec3_t vec;
    ps_parse_1d_matrix(&data, 3, vec);
    IC_ASSERT(FEQUAL(vec[0], 320.44));
    IC_ASSERT(FEQUAL(vec[1], -1544.95));
    IC_ASSERT(FEQUAL(vec[2], 12897.55));

    /* skip braced section */
    ps_skip_braced_section(&data);

    /* match token */
    ps_match_token(&data, "true", false);

    /* end */
    ps_end_session();

    return 0;
}
